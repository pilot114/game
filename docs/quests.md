Здесь представлена основная техническая информация по The Long Story - текстовой RPG игре
с упором на квестовую составляющую. The Long Story в некотором смысле представляет собой движок
для RPG игр, весь контент игры описывается в простых игровых ресурсах
(конфиг в yaml, аудиофайлы и картинки), что позволяет игрокам самим добавлять в игру
новые локации, квесты и персонажей.

Далее даны определения основных терминов и спецификация конфига.

# Локации, типы локаций, миры

Локация это некоторая область, в которой может находиться игрок. 
В каждой локации есть набор объектов, с которыми игрок может взаимодействовать.
Локации могут быть вложенными, например:

    город > таверна > подвал таверны

Ограничения:
1. Обычные локации ограничены максимальным размером координатной сетки (255x255), но могут быть
и совсем маленькими, например 2x4. Каждая локация имеет маштаб. Условно можно считать, что 1 клетка локации = 1 квадратному метру * маштаб.
2. В одной локации не должно быть более 255 объектов.

> **Технический момент**  
> Таким образом, данные о локации эффективно хранятся в памяти (3 байта на каждый объект = id + координаты).

Также есть безразмерные локации - они предназначены для перемещения между обычными
локациями (путешествие). В них нет постоянных объектов, но могут быть "случайные события".

Есть несколько способов перемещения между локациями:
- путешествие
- дверь (условно, это может быть лестница, ворота и т.д.)
- портал (односторонний или двухсторонний)

Мир (сеттинг) - это безразмерная локация, в которой находятся все другие локации.
В одном мире существует один общий лор (история, легенды, языки и т.д.), физические правила, 
и, возможно, даже ролевая система (в данный момент есть одна ролевая система по умолчанию).

Теоретически, миров может быть любое количество. Перемещение между мирами допускается
только через порталы. При перемещении персонажа между мирами, к нему должна применяться особая
процедура конвертации (изменение характеристик, предметов и пр.).

> **Технический момент**  
> Описание сеттинга представлено в виде отдельного документа, для того чтобы его было
> удобно использовать для генерации контента с помощью LLM (см. далее)

# Объекты, виды объектов, действия

Объект - это всё, с чем может взаимодействовать игрок. У каждого объекта есть собственное и игровое описание,
а также список возможных действий.

Виды объектов (не взаимоисключают друг друга):
- Персонаж - это любой объект, с которым возможен диалог (не обязательно осмысленный)
- Предмет - объект, который можно взять
- Общий объект - доступен в любом месте локации (нет конкретного размещения)
- Контейнер - объект, в котором могут быть предметы
- ...

Есть список стандартных действий:

| Действие   | Объект       |
|------------|--------------|
| Осмотреть  | Любой объект |
| Атаковать  | Любой объект |
| Поговорить | Персонаж     |
| Взять      | Предмет      |

Также у большинства предметов есть действие "Использовать".  
Оно может быть уточнено в зависимости от предмета и контекста
(съесть, прочитать, соединить, открыть и т.д.). Результаты использования
могут быть совершенно разные и должны быть прописаны в самом предмете.

Также есть действия, не применяемые к объектам напрямую:
- Отдохнуть - восстановление сил. Также можно использовать, чтобы подождать чего-либо
- Осмотреться - позволяет находить скрытые объекты (при соответствующих навыках)

> **Технический момент**  
> Список всех объектов игры храниться в локальной БД (SQLite).  
> 

# Квесты, диалоги, проверки

Квесты позволяют продвигать вперёд сюжет и служат основным способом получения опыта.  
Каждый квест состоит из набора задач (= этапы квеста). Квесты могут иметь развилки.
Квест может обращаться к объектам в локациях, а также добавлять / удалять свои объекты.

Диалог может быть как частью квеста, так у сущестововать отдельно. Каждый персонаж  
так или иначе имеет свой основной диалог. Диалоги могут иметь развилки и циклы.

В квестах и диалогах в любом месте могут быть сделаны проверки данных персонажа
(характеристики, навыка, наличия предмета), а также временных переменных, создаваемых самим квестом / персонажем.

Примеры проверок:
- Персонаж скажет фразу, только если сила игрока > 15
- Игрок может сказать фразу, только если его мудрость >= 12
- Этап квеста будет начат, если у игрока есть предмет `wooden woodpecker`
- 3 этап квеста будет начат, если выполнены флаги, выставленные на этапах 1 и 2

Вся основная информация по прогрессу квестов сохраняется в журнале квестов.

# Случайные события

Для каждой локации возможно прописать случайные события (по сути мини-квесты).  
Они позволяют сделать мир более случайным и наполненным событиями.  
Помимо обычных условий для старта, такие события также используют некоторое
значение вероятности, при которой они произойдут.

# Использование LLM (больших языковых моделей)

Описание локаций и объектов разработано таким образом, чтобы LLM могли как можно более
эффективно использовать его для создания диалогов и квестов.

Весь процесс создания контента может быть автоматизирован (требуется только корректировка
на каждом из этапов) и разбит на следующие подзадачи:
- Дать описание формата (из этого документа)
- Дать описание сеттинга (второй документ)
- Сформировать список локаций
- Сформировать список объектов для каждой локации
- Сформировать основные диалоги персонажей
- Сформировать квесты и квестовые диалоги
- Сформировать случайные встречи

# Формальное описание локации

Объект `Location`:

    name (string)                   - имя локации в игре (в строке контекста)
    info (string)                   - описание локации для LLM
    description (string)            - внутриигровое описание локации
    grid (string<Grid>)             - перечисление местоположений объектов
    objects (array<string, Object>) - все объекты в локации
    npc (array<string, Person>)     - дял удобства, объекты NPC описываются отдельно
    quests (array<string, Quest>)   - квесты

Пример строки Grid: `well:20:10 scarecrow:27:22 bench:22:14 `  
Ключи в `entities` и `quests` являются уникальными идентификаторами на английском языке.

Объект `Entity`:

    name (string)              - имя объекта в игре (в списке доступных объектов локации)
    info (string)              - описание объекта для LLM
    description (string)       - внутриигровое описание объекта
    types (string<ObjectType>) - типы объекта
    sound (?string)            - запись в логе (звук)
    unique (bool)              - является ли объект уникальным. По умолчанию false

Пример строки ObjectType: `item container`

Объект `Quest`:

    name (string)            - имя квеста в игре (в журнале квестов)
    description (string)     - внутриигровое описание квеста
    info (string)            - описание квеста для LLM
    tasks (array<int, Task>) - список этапов квеста

Объект `Task`:

    index (int)                 - номер. Обычно указывается кратно 10
    trigger (string<Trigger>)   - логическое выражение, определяющее начало задания в квесте
    journal (?string)           - запись в журнале
    message (?string)           - запись в логе
    set (?string<ToSet>)        - установка переменных квеста
    commands (?string<Command>) - для изменения объектов / диалогов

Пример строки Trigger: `checkpoint1 && hero.attentiveness > 5 && hero.isSearch`  
Пример строки ToSet: `timer = 1d, checkpoint1 = hero.position in village`  
Пример строки Command: `add tawerna.levy, delete tawerna.konny`  

`Trigger` и `ToSet` могут содержать логические выражения, которые принимают
в качестве операндов данные игрока и данные объектов локации.
`ToSet` устанавливает значения или замыкания в квестовые переменные
(замыкания периодически вызываются, пока не вернут true).

1 минута реального времени = 1 час игрового времени (1 к 60)

В выражениях могут использоваться специальные операции:
- 10% - выражение будет true с вероятностью выраженной в процентах
  случайные события проверяются 1 раз в 1 минуту реального времени
- 48h - выражение будет true через 48 игровых часов
- in - если объект находится в определенной подлокации
- К квестовым переменным можно обращаться через this.  
  К переменным объектов нужно обращаться по их уникальному идентификатору.
- this (sees / hears) Y - если персонаж увидел или услышал некоторый объект.  
  Услышать можно на некотором расстоянии, увидеть означает специально рассмотреть объект.
- можно указывать название события. Выражение становится true когда событие происходит

Важные моменты:
- В журнал добавляются только те этапы, у которых есть поле journal

Неуникальные персонажи могут использоваться как шаблоны (?)

Объект `Dialog` представляет собой набор вложенных объектов, все ключи которых
являются фразами диалога. Все значения в этих объектах являются или также объектами,
или строковыми идентификаторами диалоговых действий:
- up: вернуться на уровень выше
- start: вернуться в начало (корень) диалога
- end: конец диалога
- trade: начать торговлю
- battle: начать бой
- drop+(up/start/end): убрать текущий вариант диалога
